files:
  "/etc/systemd/system/php-fpm.service.d/restart.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Service]
      Restart=on-failure
      RestartSec=30s
      StartLimitBurst=3
      OOMScoreAdjust=-500

  "/etc/php-fpm.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [global]
      pid = /var/run/php-fpm/php-fpm.pid
      error_log = /var/log/php-fpm/error.log
      
      include=/etc/php-fpm.d/*.conf

  "/etc/php-fpm.d/www.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [www]
      user = webapp
      group = webapp
      listen = /var/run/php-fpm/www.sock
      listen.owner = webapp
      listen.group = webapp
      pm = dynamic
      pm.max_children = 5
      pm.start_servers = 2
      pm.min_spare_servers = 1
      pm.max_spare_servers = 2
      pm.max_requests = 500
      
      php_admin_value[error_log] = /var/log/php-fpm/www-error.log
      php_admin_flag[log_errors] = on
      php_admin_value[memory_limit] = 128M

container_commands:
  01_create_directories:
    command: "mkdir -p /var/run/php-fpm /var/log/php-fpm && chmod 755 /var/log/php-fpm /var/run/php-fpm"
  02_reload_systemd:
    command: "systemctl daemon-reload"
  03_test_config:
    command: "php-fpm -t || true"
  04_restart_php_fpm:
    command: "systemctl restart php-fpm || true"
    ignoreErrors: true