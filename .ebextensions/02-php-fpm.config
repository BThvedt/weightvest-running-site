files:
  "/etc/systemd/system/php-fpm.service.d/restart.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [Service]
      Restart=on-failure
      RestartSec=30s
      StartLimitBurst=3
      OOMScoreAdjust=-500

  "/etc/php-fpm.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [global]
      pid = /var/run/php-fpm/php-fpm.pid
      error_log = /var/log/php-fpm/error.log
      
      include=/etc/php-fpm.d/*.conf

  "/etc/php-fpm.d/www.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      [www]
      user = webapp
      group = webapp
      listen = /var/run/php-fpm/www.sock
      listen.owner = webapp
      listen.group = webapp
      pm = ondemand
      pm.max_children = 3
      pm.process_idle_timeout = 10s
      pm.max_requests = 200
      
      php_admin_value[error_log] = /var/log/php-fpm/www-error.log
      php_admin_flag[log_errors] = on
      php_admin_value[memory_limit] = 96M

commands:
  01_stop_php_fpm:
    command: "systemctl stop php-fpm || true"
    ignoreErrors: true
  02_create_directories:
    command: "mkdir -p /var/run/php-fpm /var/log/php-fpm && chown -R root:root /var/log/php-fpm /var/run/php-fpm && chmod 755 /var/log/php-fpm /var/run/php-fpm"
  03_test_config:
    command: "php-fpm -t"
  04_reload_systemd:
    command: "systemctl daemon-reload"
  05_start_php_fpm:
    command: "systemctl start php-fpm"
  06_enable_php_fpm:
    command: "systemctl enable php-fpm"